<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÑ Christmas Catch Clash - Host Screen</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(180deg, #0a0033 0%, #1a0033 50%, #000 100%);
            font-family: 'Press Start 2P', cursive;
            color: #fff;
            overflow: hidden;
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.1), rgba(0,0,0,0.1) 1px, transparent 1px, transparent 2px);
            pointer-events: none;
            z-index: 1000;
            opacity: 0.3;
        }

        .screen {
            display: none;
            width: 100vw;
            height: 100vh;
        }

        .screen.active {
            display: block;
        }

        /* Firebase Config Screen */
        .config-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
        }

        .config-panel {
            background: rgba(0, 0, 0, 0.95);
            border: 6px solid #ff00ff;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 0 60px #ff00ff;
            max-width: 900px;
            width: 100%;
        }

        .config-title {
            font-size: 2rem;
            color: #ff00ff;
            text-shadow: 0 0 30px #ff00ff;
            margin-bottom: 30px;
            text-align: center;
        }

        .config-instructions {
            font-size: 0.8rem;
            line-height: 2;
            color: #00ff00;
            margin: 20px 0;
        }

        .config-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid #00ffff;
            padding: 15px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.8rem;
            color: #fff;
            border-radius: 10px;
            margin: 10px 0;
        }

        .config-input:focus {
            outline: none;
            border-color: #ff00ff;
            box-shadow: 0 0 20px #ff00ff;
        }

        /* Setup Screen */
        .setup-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .setup-panel {
            background: rgba(0, 0, 0, 0.95);
            border: 6px solid #00ffff;
            padding: 50px 70px;
            border-radius: 20px;
            box-shadow: 0 0 60px #00ffff;
            max-width: 900px;
            width: 90%;
            text-align: center;
            overflow-y: auto;
            max-height: 90vh;
        }

        @media (max-width: 768px) {
            .setup-panel {
                padding: 30px 40px;
                width: 95%;
                max-height: 95vh;
            }
            
            h1 {
                font-size: 2rem !important;
            }
        }

        @media (max-height: 800px) {
            .setup-panel {
                padding: 30px 40px;
                max-height: 95vh;
            }
        }

        h1 {
            font-size: 3rem;
            color: #ff00ff;
            text-shadow: 0 0 30px #ff00ff, 0 0 60px #ff00ff, 5px 5px 0 #00ffff;
            margin-bottom: 40px;
            animation: titlePulse 2s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { text-shadow: 0 0 30px #ff00ff, 5px 5px 0 #00ffff; }
            50% { text-shadow: 0 0 60px #ff00ff, 0 0 90px #ff00ff, 5px 5px 0 #00ffff; }
        }

        .game-code-box {
            background: rgba(255, 255, 0, 0.1);
            border: 5px solid #ffff00;
            padding: 25px;
            margin: 30px 0;
            border-radius: 15px;
        }

        .code-label {
            font-size: 1rem;
            color: #00ff00;
            margin-bottom: 15px;
        }

        .code-value {
            font-size: 4.5rem;
            color: #ffff00;
            text-shadow: 0 0 30px #ffff00;
            letter-spacing: 0.3em;
        }

        .player-url {
            font-size: 0.85rem;
            color: #00ffff;
            margin: 25px 0;
            word-break: break-all;
        }

        .instructions {
            font-size: 0.85rem;
            line-height: 2.2;
            color: #00ff00;
            margin: 30px 0;
            text-align: left;
        }

        .player-waiting {
            margin: 35px 0;
            min-height: 80px;
        }

        .player-chip {
            display: inline-block;
            background: rgba(0, 255, 255, 0.2);
            border: 3px solid #00ffff;
            padding: 12px 25px;
            margin: 8px;
            border-radius: 25px;
            font-size: 0.9rem;
            animation: chipGlow 2s ease-in-out infinite;
        }

        @keyframes chipGlow {
            0%, 100% { box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 25px rgba(0, 255, 255, 0.6); }
        }

        .btn {
            background: linear-gradient(180deg, #ff0080, #cc0066);
            border: 5px solid #ff00ff;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.3rem;
            padding: 22px 55px;
            cursor: pointer;
            border-radius: 12px;
            box-shadow: 0 0 35px #ff00ff;
            transition: all 0.2s;
            margin: 25px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 55px #ff00ff;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Game Screen */
        .game-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 100;
        }

        .hud-item {
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid #00ffff;
            padding: 18px 35px;
            font-size: 1.8rem;
            border-radius: 12px;
            box-shadow: 0 0 30px #00ffff;
        }

        .timer { color: #ff0000; text-shadow: 0 0 20px #ff0000; }
        .round-name { color: #ffff00; text-shadow: 0 0 20px #ffff00; }

        .leaderboard {
            position: absolute;
            right: 20px;
            top: 110px;
            width: 380px;
            background: rgba(0, 0, 0, 0.98);
            border: 5px solid #ffff00;
            padding: 25px;
            border-radius: 18px;
            box-shadow: 0 0 50px #ffff00;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }

        .leaderboard h2 {
            font-size: 1.4rem;
            color: #ffff00;
            text-shadow: 0 0 20px #ffff00;
            text-align: center;
            margin-bottom: 25px;
        }

        .player-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid #00ff00;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .player-score:hover {
            transform: translateX(-8px);
            box-shadow: 0 0 20px #00ff00;
        }

        .score-rank {
            font-size: 1.4rem;
            color: #ff00ff;
            min-width: 65px;
        }

        .score-name {
            flex: 1;
            font-size: 1rem;
            color: #00ffff;
        }

        .score-points {
            font-size: 1.5rem;
            color: #ffff00;
            text-shadow: 0 0 12px #ffff00;
        }

        .player-score.top1 { border-color: #ffd700; box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
        .player-score.top2 { border-color: #c0c0c0; }
        .player-score.top3 { border-color: #cd7f32; }

        .game-area {
            position: absolute;
            top: 110px;
            left: 20px;
            right: 420px;
            bottom: 20px;
            border: 5px solid #00ff00;
            border-radius: 18px;
            background: rgba(0, 0, 0, 0.4);
            box-shadow: inset 0 0 30px rgba(0, 255, 0, 0.2);
        }

        .round-transition {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            animation: transitionFade 0.5s ease-out;
        }

        @keyframes transitionFade {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .round-icon {
            font-size: 7rem;
            margin-bottom: 25px;
            animation: iconBounce 1s ease-in-out infinite;
        }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .round-title {
            font-size: 3.2rem;
            color: #ff00ff;
            text-shadow: 0 0 35px #ff00ff;
            margin-bottom: 18px;
        }

        .round-desc {
            font-size: 1.4rem;
            color: #00ff00;
            margin-top: 15px;
        }

        /* Falling items */
        .falling-item {
            position: absolute;
            font-size: 3.5rem;
            animation: itemWobble 0.6s ease-in-out infinite;
            filter: drop-shadow(0 0 18px currentColor);
            pointer-events: none;
        }

        @keyframes itemWobble {
            0%, 100% { transform: rotate(-12deg); }
            50% { transform: rotate(12deg); }
        }

        /* Caught popup */
        .catch-popup {
            position: absolute;
            font-size: 2.2rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 300;
            animation: popFloat 1.2s ease-out forwards;
        }

        @keyframes popFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-120px) scale(1.8); }
        }

        /* End Screen */
        .end-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            overflow-y: auto;
            padding: 20px;
        }

        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            width: 100%;
            max-width: 1200px;
            overflow-x: auto;
        }
            gap: 35px;
            margin: 60px 0;
        }

        .podium {
            text-align: center;
            animation: podiumRise 1s ease-out;
        }

        @keyframes podiumRise {
            from { transform: translateY(150px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .podium.first { order: 2; animation-delay: 0.6s; }
        .podium.second { order: 1; animation-delay: 0.3s; }
        .podium.third { order: 3; animation-delay: 0s; }

        .podium-emoji { font-size: 6rem; margin-bottom: 18px; }
        .podium-name { font-size: 1.6rem; color: #ffff00; margin: 12px 0; }
        .podium-score { font-size: 2.2rem; color: #00ff00; text-shadow: 0 0 22px #00ff00; }

        .podium-stand {
            background: linear-gradient(180deg, rgba(255,255,255,0.25), rgba(255,255,255,0.05));
            border: 5px solid;
            border-radius: 18px 18px 0 0;
            padding: 28px;
            margin-top: 25px;
        }

        .podium.first .podium-stand {
            height: 240px;
            border-color: #ffd700;
            box-shadow: 0 0 45px rgba(255, 215, 0, 0.7);
        }

        .podium.second .podium-stand {
            height: 185px;
            border-color: #c0c0c0;
        }

        .podium.third .podium-stand {
            height: 130px;
            border-color: #cd7f32;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #00ff00;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.7rem;
            z-index: 10000;
        }

        .connection-status.disconnected {
            border-color: #ff0000;
            color: #ff0000;
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="connection-status" id="connection-status">üü¢ CONNECTED</div>

    <!-- Firebase Config Screen -->
    <div id="config-screen" class="screen active">
        <div class="config-container">
            <div class="config-panel">
                <div class="config-title">üîß FIREBASE SETUP üîß</div>
                
                <div class="config-instructions">
                    üìã FOLLOW THESE STEPS:<br><br>
                    1Ô∏è‚É£ Go to: <strong style="color: #ffff00;">https://console.firebase.google.com</strong><br>
                    2Ô∏è‚É£ Click "Add Project" or use existing project<br>
                    3Ô∏è‚É£ Click "Realtime Database" ‚Üí "Create Database"<br>
                    4Ô∏è‚É£ Choose "Start in test mode" ‚Üí Enable<br>
                    5Ô∏è‚É£ Go to Project Settings (‚öôÔ∏è) ‚Üí Your apps ‚Üí Web app<br>
                    6Ô∏è‚É£ Copy the config values and paste below:<br><br>
                    
                    <strong style="color: #ff00ff;">PASTE YOUR FIREBASE CONFIG:</strong>
                </div>

                <textarea 
                    id="firebase-config" 
                    class="config-input" 
                    placeholder='Paste entire firebaseConfig object here, e.g.:
{
  apiKey: "AIza...",
  authDomain: "...",
  databaseURL: "https://...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
}'
                    rows="10"
                ></textarea>

                <button class="btn" onclick="initializeFirebase()">‚úÖ INITIALIZE FIREBASE</button>

                <div class="config-instructions" style="margin-top: 30px; font-size: 0.7rem; color: #00ffff;">
                    üí° TIP: This is one-time setup. Your config will be saved!<br>
                    üîí Safe: Firebase is free and secure for this use case.
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Screen -->
    <div id="setup-screen" class="screen">
        <div class="setup-container">
            <div class="setup-panel">
                <h1>üéÑ CHRISTMAS CATCH CLASH üéÑ</h1>
                
                <div class="game-code-box">
                    <div class="code-label">‚ö° GAME CODE ‚ö°</div>
                    <div class="code-value" id="game-code-display">XMAS</div>
                </div>

                <div class="player-url">
                    Players join at: <strong id="player-url">player.html</strong>
                    <br>
                    <button class="btn" onclick="copyPlayerUrl()" style="font-size: 0.8rem; padding: 12px 25px; margin-top: 15px;">
                        üìã COPY PLAYER LINK
                    </button>
                </div>

                <div class="instructions">
                    üì± HOW TO PLAY:<br>
                    1Ô∏è‚É£ Click "COPY PLAYER LINK" button below<br>
                    2Ô∏è‚É£ Share that link with players in Teams chat<br>
                    3Ô∏è‚É£ Players click link on their phones (auto-connects!)<br>
                    4Ô∏è‚É£ Players enter name + game code shown above<br>
                    5Ô∏è‚É£ Start game and have fun!
                </div>

                <div class="player-waiting">
                    <div style="color: #00ff00; margin-bottom: 18px; font-size: 1.1rem;">PLAYERS JOINED: <span id="player-count">0</span></div>
                    <div id="player-list"></div>
                </div>

                <button class="btn" onclick="startGame()" id="start-btn">‚ñ∂ START GAME ‚óÄ</button>
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="game-header">
            <div class="hud-item timer" id="timer">1:30</div>
            <div class="hud-item round-name" id="round-display">ROUND 1</div>
        </div>

        <div class="game-area" id="game-area"></div>

        <div class="leaderboard">
            <h2>üèÜ LIVE SCORES üèÜ</h2>
            <div id="leaderboard-content"></div>
        </div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="screen">
        <div class="end-container">
            <div class="setup-panel">
                <h1>üéâ GAME OVER! üéâ</h1>
                
                <div style="font-size: 1.5rem; color: #ffff00; margin: 35px 0; text-shadow: 0 0 25px #ffff00; line-height: 1.6;">
                    üéÑ WISHING THE BEST TEAM EVER<br>A FAB CHRISTMAS AND BRILLIANT '26! üéÑ
                </div>

                <div class="podium-container" id="podium"></div>

                <button class="btn" onclick="location.reload()">‚Üª PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <script>
        // FIREBASE & GAME STATE
        let database = null;
        let gameRef = null;
        let gameCode = 'XMAS' + Math.random().toString(36).substr(2, 4).toUpperCase();
        
        const ROUND_DURATION = 90;
        let gameState = {
            players: {},
            isRunning: false,
            currentRound: 0,
            timeLeft: ROUND_DURATION,
            itemId: 0,
            activeItems: {},
            gameOver: false
        };

        const ROUNDS = [
            { name: 'CATCH ME IF YOU CAN', icon: 'üéÅ', type: 'catch', duration: 90 },
            { name: 'MEMORY MATCH', icon: 'üéÅ', type: 'memory', duration: 90 },
            { name: 'TAP ME OUTTA HERE', icon: '‚ö°', type: 'speed', duration: 90 },
            { name: "CARA'S DELI COUNTER", icon: 'üéÑüéÑüéÑ', type: 'deli', duration: 15 }
        ];

        const CATCH_ITEMS = [
            // Good items (green circles) - worth +10 points
            { image: 'Aaron.jpg', name: 'Aaron', points: 10, good: true },
            { image: 'Cricket.jpg', name: 'Cricket', points: 10, good: true },
            { image: 'Kelly.jpg', name: 'Kelly', points: 10, good: true },
            { image: 'Philippa.jpg', name: 'Philippa', points: 10, good: true },
            { image: 'Mi-cool.jpg', name: 'Mi-cool', points: 10, good: true },
            // Bad items (red circles) - lose -15 points  
            { image: 'Aaron.jpg', name: 'Aaron', points: -15, good: false },
            { image: 'Cara.jpg', name: 'Cara', points: -15, good: false },
            { image: 'Cricket.jpg', name: 'Cricket', points: -15, good: false },
            { image: 'Kelly.jpg', name: 'Kelly', points: -15, good: false },
            { image: 'Philippa.jpg', name: 'Philippa', points: -15, good: false },
            { image: 'Mi-cool.jpg', name: 'Mi-cool', points: -15, good: false }
        ];

        let spawnInterval = null;
        let timerInterval = null;

        // Check if Firebase config exists
        function checkFirebaseConfig() {
            const saved = localStorage.getItem('firebaseConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    initFirebase(config);
                    return true;
                } catch (e) {
                    console.error('Invalid saved config:', e);
                }
            }
            return false;
        }

        function initializeFirebase() {
            const configText = document.getElementById('firebase-config').value.trim();
            if (!configText) {
                alert('Please paste your Firebase config!');
                return;
            }

            try {
                // Parse the config (handle both JSON and JS object format)
                let config;
                if (configText.startsWith('{')) {
                    // Try as JSON first
                    try {
                        config = JSON.parse(configText);
                    } catch {
                        // If JSON fails, try eval (for JS object format)
                        config = eval('(' + configText + ')');
                    }
                } else {
                    config = eval('(' + configText + ')');
                }

                // Validate required fields
                if (!config.apiKey || !config.databaseURL) {
                    throw new Error('Missing required fields (apiKey or databaseURL)');
                }

                // Save config
                localStorage.setItem('firebaseConfig', JSON.stringify(config));

                // Initialize
                initFirebase(config);
            } catch (e) {
                alert('Error parsing config: ' + e.message + '\n\nMake sure you copied the entire firebaseConfig object!');
                console.error('Config error:', e);
            }
        }

        function initFirebase(config) {
            try {
                firebase.initializeApp(config);
                database = firebase.database();
                
                // Save config to Firebase so players can access it
                database.ref('_config').set({
                    apiKey: config.apiKey,
                    authDomain: config.authDomain,
                    databaseURL: config.databaseURL,
                    projectId: config.projectId,
                    storageBucket: config.storageBucket,
                    messagingSenderId: config.messagingSenderId,
                    appId: config.appId
                }).then(() => {
                    console.log('Config saved to Firebase for players');
                });
                
                document.getElementById('config-screen').classList.remove('active');
                document.getElementById('setup-screen').classList.add('active');
                
                setupGame();
                updateConnectionStatus();
            } catch (e) {
                alert('Firebase initialization failed: ' + e.message);
                console.error('Firebase error:', e);
                localStorage.removeItem('firebaseConfig');
            }
        }

        function updateConnectionStatus() {
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                const status = document.getElementById('connection-status');
                if (snap.val() === true) {
                    status.textContent = 'üü¢ CONNECTED';
                    status.classList.remove('disconnected');
                } else {
                    status.textContent = 'üî¥ DISCONNECTED';
                    status.classList.add('disconnected');
                }
            });
        }

        function setupGame() {
            document.getElementById('game-code-display').textContent = gameCode;
            
            // Generate player URL with database parameter
            if (window.location.href.includes('http')) {
                const baseUrl = window.location.href.replace('host.html', 'player.html');
                const config = JSON.parse(localStorage.getItem('firebaseConfig'));
                const playerUrl = baseUrl + '?db=' + encodeURIComponent(config.databaseURL);
                
                // Store full URL for copying
                window.fullPlayerUrl = playerUrl;
                
                document.getElementById('player-url').textContent = playerUrl;
                
                // Make it shorter for display if too long
                if (playerUrl.length > 80) {
                    const shortUrl = playerUrl.substring(0, 80) + '...';
                    document.getElementById('player-url').textContent = shortUrl;
                    document.getElementById('player-url').title = playerUrl; // Full URL on hover
                }
            }

            // Create game session in Firebase
            gameRef = database.ref('games/' + gameCode);
            
            // Initialize game state
            gameRef.set({
                gameCode: gameCode,
                players: {},
                isRunning: false,
                currentRound: 0,
                roundData: ROUNDS[0],
                activeItems: {},
                timestamp: Date.now()
            });

            // Listen for players joining
            gameRef.child('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                gameState.players = players;
                updatePlayerList();
                updateLeaderboard();
            });

            // Listen for caught items
            gameRef.child('caughtItems').on('child_added', (snapshot) => {
                const caught = snapshot.val();
                handleCatch(caught);
                // Remove processed item
                snapshot.ref.remove();
            });
        }

        function copyPlayerUrl() {
            const url = window.fullPlayerUrl || document.getElementById('player-url').textContent;
            
            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('‚úÖ Player link copied!\n\nShare this link with players:\n' + url);
                }).catch(() => {
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(url);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('‚úÖ Player link copied!\n\nShare this link with players:\n' + text);
            } catch (err) {
                alert('üìã Copy this link:\n\n' + text);
            }
            document.body.removeChild(textarea);
        }

        function updatePlayerList() {
            const list = document.getElementById('player-list');
            const players = Object.values(gameState.players);
            
            document.getElementById('player-count').textContent = players.length;
            
            if (players.length === 0) {
                list.innerHTML = '<div class="player-chip">Waiting for players...</div>';
            } else {
                list.innerHTML = players
                    .map(p => `<div class="player-chip">üë§ ${p.name}</div>`)
                    .join('');
            }
        }

        function handleCatch(caught) {
            if (!gameState.activeItems[caught.itemId]) return;

            const itemData = gameState.activeItems[caught.itemId];
            const player = gameState.players[caught.playerId];
            
            if (player) {
                player.score = (player.score || 0) + itemData.points;
                
                // Update player score in Firebase
                gameRef.child('players/' + caught.playerId + '/score').set(player.score);
                
                // Show popup
                const popup = document.createElement('div');
                popup.className = 'catch-popup';
                popup.textContent = `${player.name} ${itemData.points > 0 ? '+' : ''}${itemData.points}`;
                popup.style.left = itemData.x + '%';
                popup.style.top = itemData.y + 'px';
                popup.style.color = itemData.points > 0 ? '#00ff00' : '#ff0000';
                popup.style.textShadow = `0 0 20px ${itemData.points > 0 ? '#00ff00' : '#ff0000'}`;
                document.getElementById('game-area').appendChild(popup);
                setTimeout(() => popup.remove(), 1200);

                // Remove item
                const itemEl = document.querySelector(`[data-item-id="${caught.itemId}"]`);
                if (itemEl) itemEl.remove();
                delete gameState.activeItems[caught.itemId];
                
                updateLeaderboard();
            }
        }

        function updateLeaderboard() {
            const sorted = Object.values(gameState.players).sort((a, b) => (b.score || 0) - (a.score || 0));
            document.getElementById('leaderboard-content').innerHTML = sorted
                .map((p, i) => `
                    <div class="player-score ${i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : ''}">
                        <span class="score-rank">#${i + 1}</span>
                        <span class="score-name">${p.name}</span>
                        <span class="score-points">${p.score || 0}</span>
                    </div>
                `).join('');
        }

        function startGame() {
            if (Object.keys(gameState.players).length === 0) {
                alert('Wait for at least one player to join!');
                return;
            }

            gameState.isRunning = true;
            gameState.currentRound = 0;
            
            gameRef.update({
                isRunning: true,
                currentRound: 0,
                timeLeft: ROUND_DURATION
            });

            document.getElementById('setup-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');

            startRound(0);
        }

        function startRound(roundIndex) {
            gameState.currentRound = roundIndex;
            const round = ROUNDS[roundIndex];
            gameState.timeLeft = round.duration;
            
            document.getElementById('round-display').textContent = 
                `ROUND ${roundIndex + 1}: ${round.name}`;

            // Show instruction screen
            const gameArea = document.getElementById('game-area');
            
            let instructionText = '';
            if (round.type === 'catch') {
                instructionText = 'TAP THE FALLING ELVES!<br>First tap wins points!<br>Avoid bad items!';
            } else if (round.type === 'memory') {
                instructionText = 'FIND MATCHING PAIRS!<br>+15 points per match!';
            } else if (round.type === 'speed') {
                instructionText = 'TAP TARGETS FAST!<br>First to tap wins +20 points!<br>Ready your fingers!';
            } else if (round.type === 'deli') {
                instructionText = 'HIT CARA AS MANY TIMES AS YOU CAN<br>TO GET THE FIRST TICKET IN THE QUEUE!<br>Most taps wins!';
            }
            
            gameArea.innerHTML = `
                <div class="round-transition">
                    <div class="round-icon">${round.icon}</div>
                    <div class="round-title">${round.name}</div>
                    <div class="round-desc" style="font-size: 1.2rem; line-height: 1.8;">${instructionText}</div>
                    <button class="btn" onclick="startRoundCountdown()" style="margin-top: 30px; font-size: 1.5rem; padding: 15px 40px; animation: buttonGlow 2s ease-in-out infinite;">
                        ‚ñ∂ START ROUND ‚óÄ
                    </button>
                    <div id="countdown-display" style="font-size: 1.8rem; color: #ffff00; margin-top: 20px; display: none;">
                        Starting in <span id="countdown">3</span>...
                    </div>
                </div>
            `;

            gameRef.update({
                currentRound: roundIndex,
                roundData: round,
                timeLeft: round.duration,
                roundStarted: false  // Reset flag for new round
            });
        }

        // Function called when host clicks "START ROUND" button
        function startRoundCountdown() {
            const currentRoundIndex = gameState.currentRound;
            const round = ROUNDS[currentRoundIndex];
            const gameArea = document.getElementById('game-area');
            
            // Hide button, show countdown
            document.getElementById('countdown-display').style.display = 'block';
            const btn = gameArea.querySelector('button');
            if (btn) btn.style.display = 'none';
            
            // Signal to players that round is starting
            gameRef.update({ roundStarted: true });
            
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownEl = document.getElementById('countdown');
                if (countdownEl) {
                    if (countdown > 0) {
                        countdownEl.textContent = countdown;
                    } else {
                        countdownEl.textContent = 'GO!';
                    }
                }
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    gameArea.innerHTML = '';
                    startTimer();
                    
                    if (round.type === 'catch') {
                        startCatchGame();
                    } else if (round.type === 'memory') {
                        startMemoryGameHost(); // Show message on host screen
                    } else if (round.type === 'speed') {
                        startSpeedGame();
                        startSpeedGameHost(); // Show message on host screen
                    } else if (round.type === 'deli') {
                        startDeliGame();
                    }
                }
            }, 1000);
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                gameState.timeLeft--;
                const mins = Math.floor(gameState.timeLeft / 60);
                const secs = gameState.timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${mins}:${secs.toString().padStart(2, '0')}`;

                gameRef.update({ timeLeft: gameState.timeLeft });

                if (gameState.timeLeft <= 0) {
                    clearInterval(timerInterval);
                    clearInterval(spawnInterval);
                    nextRound();
                }
            }, 1000);
        }

        function startCatchGame() {
            spawnCatchItem();
            spawnInterval = setInterval(() => spawnCatchItem(), 600); // Faster spawning: 600ms (was 900ms)
        }

        function spawnCatchItem() {
            const item = CATCH_ITEMS[Math.floor(Math.random() * CATCH_ITEMS.length)];
            const itemId = ++gameState.itemId;
            
            const itemData = {
                id: itemId,
                image: item.image,
                name: item.name,
                points: item.points,
                good: item.good,
                x: Math.random() * 85 + 5,
                y: -50
            };

            gameState.activeItems[itemId] = itemData;

            const itemEl = document.createElement('div');
            itemEl.className = 'falling-item';
            
            // Create image element for team photos
            const img = document.createElement('img');
            img.src = itemData.image;
            img.style.width = '80px';
            img.style.height = '80px';
            img.style.borderRadius = '50%';
            img.style.border = item.good ? '4px solid #00ff00' : '4px solid #ff0000';
            img.style.boxShadow = item.good ? '0 0 20px #00ff00' : '0 0 20px #ff0000';
            
            // Handle image loading errors
            img.onerror = function() {
                console.error('Failed to load image:', itemData.image);
                itemEl.textContent = item.good ? '‚úÖ' : '‚ùå';
                itemEl.style.fontSize = '4rem';
            };
            
            itemEl.appendChild(img);
            
            itemEl.style.left = itemData.x + '%';
            itemEl.style.top = itemData.y + 'px';
            itemEl.dataset.itemId = itemId;
            document.getElementById('game-area').appendChild(itemEl);

            // Update Firebase with initial position
            gameRef.child('activeItems/' + itemId).set(itemData);

            // Animate fall - MUCH FASTER!
            let pos = -50;
            const fallSpeed = 4 + Math.random() * 3; // Faster: 4-7px per frame (was 2.5-4)
            const fallInterval = setInterval(() => {
                pos += fallSpeed;
                itemEl.style.top = pos + 'px';
                itemData.y = pos;

                // Update Firebase for smooth sync
                if (Math.random() < 0.3) {
                    gameRef.child('activeItems/' + itemId + '/y').set(pos);
                }

                if (pos > window.innerHeight - 150) {
                    clearInterval(fallInterval);
                    delete gameState.activeItems[itemId];
                    itemEl.remove();
                    gameRef.child('activeItems/' + itemId).remove();
                }
            }, 20);
        }

        function startSpeedGame() {
            spawnSpeedTarget();
            spawnInterval = setInterval(() => spawnSpeedTarget(), 500); // Faster: 500ms (was 700ms)
        }

        function startDeliGame() {
            // Deli Counter - players tap Cara as many times as possible
            // No health bar, Cara never disappears, most taps wins
            const gameArea = document.getElementById('game-area');
            
            gameArea.innerHTML = `
                <div style="background-image: url('deli-background.png'); background-size: cover; background-position: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; position: relative;">
                    <!-- Dark overlay for better contrast -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.3); pointer-events: none;"></div>
                    
                    <div style="position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center;">
                        <img src="Cara.jpg" id="cara-deli" style="width: 250px; height: 250px; border-radius: 50%; border: 8px solid #ff00ff; box-shadow: 0 0 40px #ff00ff, 0 10px 40px rgba(0, 0, 0, 0.5); cursor: pointer; animation: deliFloat 1.5s ease-in-out infinite; user-select: none;">
                        <div style="font-size: 2rem; color: #ff00ff; text-shadow: 0 0 25px #ff00ff, 0 0 40px #ff00ff, 2px 2px 4px rgba(0,0,0,0.8); margin: 30px 0; text-align: center; font-weight: bold;">
                            CARA'S CHRISTMAS DELI COUNTER
                        </div>
                        <div style="font-size: 1.2rem; color: #00ff00; text-shadow: 0 0 20px #00ff00, 2px 2px 4px rgba(0,0,0,0.8); text-align: center; line-height: 1.8; max-width: 600px;">
                            TAP CARA TO GET YOUR TICKET!<br>
                            <span style="font-size: 0.9rem;">Most taps wins this round!</span>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes deliFloat {
                        0%, 100% { transform: translateY(0) scale(1); }
                        50% { transform: translateY(-15px) scale(1.05); }
                    }
                    #cara-deli:active {
                        transform: scale(0.9) !important;
                    }
                </style>
            `;
            
            // No spawning or health tracking - players just tap Cara image
            // Points are awarded on each tap (handled in player catching)
        }

        function startSpeedGameHost() {
            // Speed game - show message on host screen
            const gameArea = document.getElementById('game-area');
            
            gameArea.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: 30px; animation: pulse 1s ease-in-out infinite;">‚ö°</div>
                    <div style="font-size: 2rem; color: #ff00ff; text-shadow: 0 0 25px #ff00ff; margin-bottom: 20px;">
                        TAP ME OUTTA HERE
                    </div>
                    <div style="font-size: 1.3rem; color: #00ff00; line-height: 1.8; max-width: 600px;">
                        Players are tapping targets on their phones!<br>
                        <span style="font-size: 1rem; color: #ffff00;">First tap wins +20 points!</span>
                    </div>
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); opacity: 1; }
                        50% { transform: scale(1.2); opacity: 0.8; }
                    }
                </style>
            `;
        }

        function startMemoryGameHost() {
            // Memory game - show message on host screen
            const gameArea = document.getElementById('game-area');
            
            gameArea.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: 30px; animation: pulse 1s ease-in-out infinite;">üéÅ</div>
                    <div style="font-size: 2rem; color: #ff00ff; text-shadow: 0 0 25px #ff00ff; margin-bottom: 20px;">
                        MEMORY MATCH
                    </div>
                    <div style="font-size: 1.8rem; color: #00ff00; text-shadow: 0 0 20px #00ff00; line-height: 1.8; max-width: 600px; font-weight: bold;">
                        üì± WATCH YOUR PHONE! üì±
                    </div>
                    <div style="font-size: 1.1rem; color: #ffff00; margin-top: 20px;">
                        Players are finding matching pairs!
                    </div>
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { transform: scale(1); opacity: 1; }
                        50% { transform: scale(1.2); opacity: 0.8; }
                    }
                </style>
            `;
        }

        function spawnSpeedTarget() {
            const itemId = ++gameState.itemId;
            
            // Randomize elf photos for speed targets
            const elfPhotos = ['Aaron.jpg', 'Cara.jpg', 'Cricket.jpg', 'Kelly.jpg', 'Philippa.jpg', 'Mi-cool.jpg'];
            const randomElf = elfPhotos[Math.floor(Math.random() * elfPhotos.length)];
            
            const itemData = {
                id: itemId,
                image: randomElf,
                points: 20,
                x: Math.random() * 80 + 10,
                y: Math.random() * 60 + 20
            };

            gameState.activeItems[itemId] = itemData;
            gameRef.child('activeItems').update({ [itemId]: itemData });

            setTimeout(() => {
                delete gameState.activeItems[itemId];
                gameRef.child('activeItems/' + itemId).remove();
            }, 1200);
        }

        function nextRound() {
            document.getElementById('game-area').innerHTML = '';
            gameState.activeItems = {};
            gameRef.child('activeItems').set({});

            if (gameState.currentRound < ROUNDS.length - 1) {
                setTimeout(() => startRound(gameState.currentRound + 1), 2000);
            } else {
                endGame();
            }
        }

        function endGame() {
            gameState.isRunning = false;
            gameState.gameOver = true;
            
            gameRef.update({
                isRunning: false,
                gameOver: true
            });

            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('end-screen').classList.add('active');

            const sorted = Object.values(gameState.players).sort((a, b) => (b.score || 0) - (a.score || 0));
            const podium = document.getElementById('podium');
            
            // Simple design: Winners at top, team at bottom!
            let podiumHTML = `
                <style>
                    @keyframes neonFlash {
                        0%, 100% { 
                            text-shadow: 0 0 5px currentColor, 0 0 10px currentColor;
                            opacity: 1;
                        }
                        50% { 
                            text-shadow: 0 0 3px currentColor, 0 0 8px currentColor;
                            opacity: 0.9;
                        }
                    }
                    @keyframes medalSpin {
                        0% { transform: rotateY(0deg) scale(1); }
                        25% { transform: rotateY(180deg) scale(1.1); }
                        50% { transform: rotateY(360deg) scale(1); }
                        75% { transform: rotateY(180deg) scale(1.1); }
                        100% { transform: rotateY(360deg) scale(1); }
                    }
                    @keyframes slideInFromBottom {
                        from { transform: translateY(100px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    @keyframes teamBounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-10px); }
                    }
                    @keyframes starBurst {
                        0% { transform: scale(0) rotate(0deg); opacity: 0; }
                        50% { opacity: 1; }
                        100% { transform: scale(1.5) rotate(180deg); opacity: 0; }
                    }
                </style>

                <div style="display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 500px; padding: 20px;">
                    
                    <!-- TOP: WINNERS with BIG MEDALS -->
                    <div style="text-align: center; width: 100%; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: center; align-items: flex-start; gap: 60px; margin-bottom: 40px;">
            `;
            
            // Top 3 winners with medals
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const colors = ['#ffd700', '#c0c0c0', '#cd7f32'];
            const sizes = ['8rem', '6rem', '5rem'];
            
            sorted.slice(0, 3).forEach((p, i) => {
                podiumHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; animation: slideInFromBottom 0.6s ease-out ${i * 0.2}s both;">
                        <!-- Big spinning medal -->
                        <div style="font-size: ${sizes[i]}; animation: medalSpin 4s ease-in-out infinite; animation-delay: ${i * 0.5}s;">
                            ${medals[i]}
                        </div>
                        
                        <!-- Flashing name -->
                        <div style="font-size: 2rem; font-weight: bold; color: ${colors[i]}; margin: 15px 0; animation: neonFlash 2s ease-in-out infinite; animation-delay: ${i * 0.3}s; letter-spacing: 2px; text-transform: uppercase;">
                            ${p.name}
                        </div>
                        
                        <!-- Score with stars -->
                        <div style="position: relative; display: inline-block;">
                            <div style="font-size: 1.8rem; color: #fff; text-shadow: 0 0 20px ${colors[i]}; font-weight: bold;">
                                ${p.score || 0} PTS
                            </div>
                            <div style="position: absolute; top: -10px; left: -20px; font-size: 2rem; animation: starBurst 2s ease-out infinite; animation-delay: ${i * 0.4}s;">‚≠ê</div>
                            <div style="position: absolute; top: -10px; right: -20px; font-size: 2rem; animation: starBurst 2s ease-out infinite; animation-delay: ${i * 0.4 + 1}s;">‚≠ê</div>
                        </div>
                    </div>
                `;
            });
            
            podiumHTML += `
                        </div>
                    </div>

                    <!-- MIDDLE: MESSAGE -->
                    <div style="font-size: 1.5rem; color: #ffff00; text-shadow: 0 0 8px #ffff00, 2px 2px 4px rgba(0,0,0,0.8); margin: 30px 0; text-align: center; line-height: 1.6; animation: neonFlash 3s ease-in-out infinite; max-width: 700px; font-weight: bold;">
                        üéÑ WISHING THE BEST TEAM EVER<br>A FAB CHRISTMAS AND BRILLIANT '26! üéÑ
                    </div>

                    <!-- BOTTOM: ALL THE TEAM -->
                    <div style="width: 100%; margin-top: 30px;">
                        <div style="font-size: 1.5rem; color: #00ff00; text-shadow: 0 0 10px #00ff00, 2px 2px 4px rgba(0,0,0,0.8); text-align: center; margin-bottom: 20px; font-weight: bold;">
                            üéÖ THE TEAM üéÖ
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 20px; border: 3px solid #00ff00; box-shadow: 0 0 20px #00ff00;">
                            <!-- Row 1: Cara, Mi-cool, Cricket -->
                            <div style="display: flex; justify-content: center; gap: 30px;">
            `;
            
            // Row 1: Cara, Mi-cool, Cricket
            const row1 = [
                { photo: 'Cara.jpg', name: 'Cara' },
                { photo: 'Mi-cool.jpg', name: 'Mi-cool' },
                { photo: 'Cricket.jpg', name: 'Cricket' }
            ];
            
            row1.forEach((member, i) => {
                podiumHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; animation: slideInFromBottom 0.5s ease-out ${i * 0.1 + 0.8}s both;">
                        <img src="${member.photo}" 
                             style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid #00ff00; box-shadow: 0 0 15px #00ff00; animation: teamBounce 2s ease-in-out infinite; animation-delay: ${i * 0.2}s;"
                             onerror="this.style.display='none';">
                        <div style="font-size: 0.9rem; color: #fff; margin-top: 8px; text-shadow: 0 0 8px #00ff00, 1px 1px 2px rgba(0,0,0,0.8); font-weight: bold;">
                            ${member.name}
                        </div>
                    </div>
                `;
            });
            
            podiumHTML += `
                            </div>
                            <!-- Row 2: Philippa, Kelly, Aaron -->
                            <div style="display: flex; justify-content: center; gap: 30px;">
            `;
            
            // Row 2: Philippa, Kelly, Aaron
            const row2 = [
                { photo: 'Philippa.jpg', name: 'Philippa' },
                { photo: 'Kelly.jpg', name: 'Kelly' },
                { photo: 'Aaron.jpg', name: 'Aaron' }
            ];
            
            row2.forEach((member, i) => {
                podiumHTML += `
                    <div style="display: flex; flex-direction: column; align-items: center; animation: slideInFromBottom 0.5s ease-out ${(i + 3) * 0.1 + 0.8}s both;">
                        <img src="${member.photo}" 
                             style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid #00ff00; box-shadow: 0 0 15px #00ff00; animation: teamBounce 2s ease-in-out infinite; animation-delay: ${(i + 3) * 0.2}s;"
                             onerror="this.style.display='none';">
                        <div style="font-size: 0.9rem; color: #fff; margin-top: 8px; text-shadow: 0 0 8px #00ff00, 1px 1px 2px rgba(0,0,0,0.8); font-weight: bold;">
                            ${member.name}
                        </div>
                    </div>
                `;
            });
            
            podiumHTML += `
                            </div>
                        </div>
                    </div>
                    
                </div>
            `;
            
            podium.innerHTML = podiumHTML;
        }

        // Initialize
        window.onload = () => {
            if (!checkFirebaseConfig()) {
                console.log('No Firebase config found, showing setup screen');
            }
        };
    </script>
</body>
</html>
