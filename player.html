<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÆ Christmas Catch - Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(135deg, #0a0033 0%, #1a0033 40%, #2d0a4e 70%, #0a0033 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            font-family: 'Press Start 2P', cursive;
            color: #fff;
            overflow: hidden;
            touch-action: manipulation;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .screen {
            display: none;
            width: 100vw;
            height: 100vh;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Join Screen */
        .join-card {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 0, 40, 0.95));
            border: 5px solid #00ffff;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 0 50px #00ffff, 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 420px;
            width: 90%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .join-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(0, 255, 255, 0.05), transparent);
            animation: cardGlow 3s ease-in-out infinite;
        }

        @keyframes cardGlow {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            50% { transform: translateX(50%) rotate(180deg); }
        }

        h1 {
            font-size: 1.6rem;
            color: #ff00ff;
            text-shadow: 0 0 20px #ff00ff;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid #ffff00;
            padding: 16px;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            color: #fff;
            border-radius: 10px;
            text-align: center;
            margin: 12px 0;
        }

        input:focus {
            outline: none;
            border-color: #ff00ff;
            box-shadow: 0 0 20px #ff00ff;
        }

        .btn {
            width: 100%;
            background: linear-gradient(135deg, #ff0080, #ff00ff, #cc0066);
            background-size: 200% 200%;
            animation: buttonGradient 3s ease infinite;
            border: 4px solid #ff00ff;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            padding: 18px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 0 30px #ff00ff, 0 5px 20px rgba(255, 0, 255, 0.3);
            margin-top: 18px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        @keyframes buttonGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: buttonShine 2s ease-in-out infinite;
        }

        @keyframes buttonShine {
            0%, 100% { transform: translateX(-100%) rotate(45deg); }
            50% { transform: translateX(100%) rotate(45deg); }
        }

        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 50px #ff00ff, 0 2px 10px rgba(255, 0, 255, 0.5);
        }

        .info-text {
            font-size: 0.7rem;
            color: #00ffff;
            margin-top: 25px;
            line-height: 1.8;
        }

        .error-text {
            font-size: 0.8rem;
            color: #ff0000;
            margin-top: 20px;
            line-height: 1.6;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff0000;
            border-radius: 10px;
        }

        /* Game Screen - keeping all the same styles from before */
        #game-screen {
            padding: 0;
            justify-content: flex-start;
        }

        .game-header {
            width: 100%;
            padding: 18px;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #00ffff;
        }

        .player-name {
            font-size: 0.75rem;
            color: #00ffff;
        }

        .score-display {
            font-size: 1.8rem;
            color: #ffff00;
            text-shadow: 0 0 18px #ffff00;
        }

        .round-banner {
            width: 100%;
            padding: 15px;
            background: rgba(255, 0, 255, 0.2);
            border-bottom: 3px solid #ff00ff;
            text-align: center;
            font-size: 0.9rem;
            color: #ff00ff;
        }

        .game-area {
            flex: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }

        .falling-item {
            position: absolute;
            font-size: 4rem;
            cursor: pointer;
            z-index: 100;
            animation: itemWobble 0.5s ease-in-out infinite;
            filter: drop-shadow(0 0 15px currentColor) drop-shadow(0 0 25px currentColor);
            transition: transform 0.1s;
        }

        @keyframes itemWobble {
            0%, 100% { transform: rotate(-10deg) scale(1); }
            50% { transform: rotate(10deg) scale(1.05); }
        }

        .falling-item:active {
            transform: scale(1.4) !important;
            filter: drop-shadow(0 0 25px currentColor) drop-shadow(0 0 40px currentColor) !important;
        }

        .falling-item::before {
            content: '‚ú®';
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 0.8rem;
            animation: sparkle 1s ease-in-out infinite;
            opacity: 0.7;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.2) rotate(180deg); }
        }

        .speed-target {
            position: absolute;
            width: 90px;
            height: 90px;
            font-size: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: targetPulse 0.6s ease-in-out infinite;
            filter: drop-shadow(0 0 20px #ff00ff) drop-shadow(0 0 35px #ff00ff);
            transition: all 0.1s;
        }

        @keyframes targetPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg); 
                filter: drop-shadow(0 0 20px #ff00ff) drop-shadow(0 0 35px #ff00ff);
            }
            50% { 
                transform: scale(1.2) rotate(10deg); 
                filter: drop-shadow(0 0 30px #ff00ff) drop-shadow(0 0 50px #ff00ff);
            }
        }

        .speed-target:active {
            transform: scale(1.5) !important;
            filter: drop-shadow(0 0 40px #ffff00) drop-shadow(0 0 60px #ffff00) !important;
        }

        .speed-target::after {
            content: '';
            position: absolute;
            width: 110%;
            height: 110%;
            border: 3px solid #ff00ff;
            border-radius: 50%;
            animation: targetRing 1s ease-out infinite;
        }

        @keyframes targetRing {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 25px;
            max-width: 500px;
            margin: 0 auto;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.15), rgba(0, 200, 255, 0.25));
            border: 3px solid #00ffff;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .memory-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: cardShine 3s ease-in-out infinite;
        }

        @keyframes cardShine {
            0%, 100% { transform: translateX(-100%) rotate(45deg); }
            50% { transform: translateX(100%) rotate(45deg); }
        }

        .memory-card:active {
            transform: scale(1.1) rotateY(10deg);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
        }

        .memory-card.flipped {
            background: linear-gradient(135deg, rgba(255, 0, 255, 0.3), rgba(255, 0, 200, 0.4));
            border-color: #ff00ff;
            transform: rotateY(180deg);
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
        }

        .memory-card.matched {
            background: linear-gradient(135deg, rgba(0, 255, 0, 0.3), rgba(0, 200, 0, 0.4));
            border-color: #00ff00;
            pointer-events: none;
            animation: matchPulse 0.5s ease-out;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.7);
        }

        @keyframes matchPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .boss-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
        }

        .boss-sprite {
            font-size: 10rem;
            margin-bottom: 30px;
            cursor: pointer;
            animation: bossFloat 2s ease-in-out infinite;
            user-select: none;
        }

        @keyframes bossFloat {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-25px) rotate(5deg); }
        }

        .boss-sprite:active {
            transform: scale(1.2) !important;
        }

        .boss-health {
            width: 100%;
            max-width: 400px;
            margin: 20px 0;
        }

        .health-bar {
            width: 100%;
            height: 35px;
            background: rgba(0, 0, 0, 0.6);
            border: 3px solid #ff0000;
            border-radius: 18px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600);
            transition: width 0.3s;
        }

        .health-text {
            color: #ffff00;
            margin-top: 12px;
            font-size: 1.3rem;
            text-align: center;
        }

        .boss-instruction {
            font-size: 1rem;
            color: #00ff00;
            text-align: center;
            margin-top: 25px;
            line-height: 1.8;
        }

        .tap-feedback {
            position: absolute;
            font-size: 3rem;
            pointer-events: none;
            z-index: 200;
            animation: feedbackPop 0.8s ease-out forwards;
            font-weight: bold;
            text-shadow: 0 0 20px currentColor;
        }

        @keyframes feedbackPop {
            0% { 
                opacity: 1; 
                transform: scale(0.5) translateY(0); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1.8) translateY(-30px); 
            }
            100% { 
                opacity: 0; 
                transform: scale(1) translateY(-80px); 
            }
        }

        /* Add particle burst on catch */
        @keyframes particleBurst {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        .status-card {
            background: rgba(0, 0, 0, 0.95);
            border: 4px solid #00ffff;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 0 40px #00ffff;
            max-width: 420px;
            width: 90%;
        }

        .status-message {
            font-size: 0.9rem;
            color: #00ff00;
            line-height: 2.2;
            margin: 25px 0;
        }

        .waiting-message {
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .final-rank {
            font-size: 2.5rem;
            margin: 30px 0;
        }

        .final-score {
            font-size: 3rem;
            color: #ffff00;
            text-shadow: 0 0 25px #ffff00;
            margin: 25px 0;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #00ff00;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.6rem;
            z-index: 10000;
        }

        .connection-status.disconnected {
            border-color: #ff0000;
            color: #ff0000;
        }

        .sound-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ffff00;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 1.5rem;
            z-index: 10000;
            cursor: pointer;
            user-select: none;
        }

        .sound-toggle:active {
            transform: scale(0.9);
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.3rem; }
            .falling-item { font-size: 3rem; }
            .speed-target { width: 75px; height: 75px; font-size: 3rem; }
            .memory-card { font-size: 2.2rem; }
            .boss-sprite { font-size: 8rem; }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">üü° INIT</div>
    <div class="sound-toggle" id="sound-toggle" onclick="toggleSound()" title="Toggle Sound">üîä</div>

    <!-- Join Screen -->
    <div id="join-screen" class="screen active">
        <div class="join-card">
            <h1>üéÑ TEAM 8's Up to Snow Good üéÑ</h1>
            
            <input 
                type="text" 
                id="player-name" 
                placeholder="YOUR NAME"
                maxlength="15"
            >

            <input 
                type="text" 
                id="game-code" 
                placeholder="GAME CODE"
                maxlength="10"
            >

            <button class="btn" onclick="joinGame()">JOIN GAME</button>
            
            <div id="error-message" class="error-text" style="display: none;"></div>
        </div>
    </div>

    <!-- Waiting Screen -->
    <div id="waiting-screen" class="screen">
        <div class="status-card">
            <h1 class="waiting-message">‚è≥ WAITING ‚è≥</h1>
            <div class="status-message" id="waiting-message">
                Waiting for host to start the game...
            </div>
            <div class="final-score" id="waiting-score">0</div>
            <div class="info-text">
                Get ready!
            </div>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="screen">
        <div class="game-header">
            <div class="player-name" id="player-name-display"></div>
            <div class="score-display" id="game-score">0</div>
        </div>
        <div class="round-banner" id="round-banner">ROUND 1</div>
        <div class="game-area" id="game-area"></div>
    </div>

    <!-- End Screen -->
    <div id="end-screen" class="screen">
        <div class="status-card">
            <h1>üéâ GAME OVER! üéâ</h1>
            <div class="final-rank" id="final-rank">ü•á</div>
            <div class="final-score" id="final-score">0 PTS</div>
            <div class="status-message">
                üéÑ MERRY CHRISTMAS! üéÑ<br>
                Check the main screen for full rankings!
            </div>
            <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        // Get database URL from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const dbUrl = urlParams.get('db');
        
        let database = null;
        let gameRef = null;
        
        const PLAYER_ID = localStorage.getItem('playerId') || 
            'player_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('playerId', PLAYER_ID);

        let playerState = {
            id: PLAYER_ID,
            name: '',
            score: 0
        };

        const ROUNDS = [
            { name: 'CATCH ME IF YOU CAN', icon: 'üéÅ', type: 'catch', duration: 90 },
            { name: 'MEMORY MATCH', icon: 'üéÅ', type: 'memory', duration: 90 },
            { name: 'TAP ME OUTTA HERE', icon: '‚ö°', type: 'speed', duration: 90 },
            { name: "CARA'S DELI COUNTER", icon: 'üéÑüéÑüéÑ', type: 'deli', duration: 15 }
        ];

        let activeItems = new Map();
        let memoryFlipped = [];
        let memoryCards = [];
        let currentRound = -1;
        
        // Sound and Vibration Settings
        let soundEnabled = true;
        let audioContext = null;

        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play sound effect
        function playSound(type) {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Round-specific frequency adjustments
            let freqMultiplier = 1;
            if (currentRound === 0) {
                freqMultiplier = 1.2; // Round 1: Higher pitched, bouncy
            } else if (currentRound === 1) {
                freqMultiplier = 0.9; // Round 2: Lower, melodic
            } else if (currentRound === 2) {
                freqMultiplier = 1.5; // Round 3: Very high, urgent
            } else if (currentRound === 3) {
                freqMultiplier = 0.7; // Round 4: Low, funny
            }
            
            // Different sounds for different actions
            if (type === 'catch-good') {
                oscillator.frequency.setValueAtTime(800 * freqMultiplier, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200 * freqMultiplier, audioContext.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            } else if (type === 'catch-bad') {
                oscillator.frequency.setValueAtTime(200 * freqMultiplier, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100 * freqMultiplier, audioContext.currentTime + 0.2);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            } else if (type === 'tap') {
                oscillator.frequency.setValueAtTime(600 * freqMultiplier, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
            } else if (type === 'match') {
                // Memory match: musical chord-like sound
                oscillator.frequency.setValueAtTime(1000 * freqMultiplier, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1500 * freqMultiplier, audioContext.currentTime + 0.15);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            } else if (type === 'countdown') {
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.08);
            } else if (type === 'go') {
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            }
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Vibrate phone
        function vibrate(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Toggle sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('sound-toggle');
            if (btn) {
                btn.textContent = soundEnabled ? 'üîä' : 'üîá';
            }
        }

        // Initialize Firebase immediately
        window.onload = function() {
            if (!dbUrl) {
                showError('‚ùå Invalid player link!<br><br>Please use the link from the host screen.<br><br>It should look like:<br>...player.html?db=https://...');
                return;
            }

            // Clean the URL (remove trailing slash and any paths)
            let cleanUrl = dbUrl.trim();
            if (cleanUrl.endsWith('/')) {
                cleanUrl = cleanUrl.slice(0, -1);
            }
            
            // Remove any paths after .com (Firebase URLs should end with .com or .io)
            const match = cleanUrl.match(/(https:\/\/[^\/]+\.(?:firebaseio\.com|googleapis\.com))/);
            if (match) {
                cleanUrl = match[1];
            }

            console.log('Connecting to:', cleanUrl);
            document.getElementById('connection-status').textContent = 'üü° CONNECTING';

            try {
                const config = {
                    databaseURL: cleanUrl
                };
                
                firebase.initializeApp(config);
                database = firebase.database();
                
                // Test connection
                database.ref('.info/connected').on('value', (snap) => {
                    const status = document.getElementById('connection-status');
                    if (snap.val() === true) {
                        status.textContent = 'üü¢ OK';
                        status.classList.remove('disconnected');
                    } else {
                        status.textContent = 'üî¥ OFF';
                        status.classList.add('disconnected');
                    }
                });

                console.log('Firebase initialized successfully');
            } catch (e) {
                console.error('Firebase error:', e);
                showError('Connection failed!<br><br>' + e.message + '<br><br>Please ask the host for a new link.');
            }
        };

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.innerHTML = message;
            errorEl.style.display = 'block';
        }

        function joinGame() {
            const name = document.getElementById('player-name').value.trim();
            const code = document.getElementById('game-code').value.trim().toUpperCase();

            if (!name || name.length < 2) {
                alert('Please enter your name!');
                return;
            }

            if (!code || code.length < 4) {
                alert('Please enter the game code!');
                return;
            }

            if (!database) {
                showError('Not connected! Please refresh and try again.');
                return;
            }

            playerState.name = name;
            document.getElementById('player-name-display').textContent = name;

            // Check if game exists
            gameRef = database.ref('games/' + code);
            gameRef.once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    alert('Game not found! Check the code and try again.');
                    return;
                }

                // Join the game
                gameRef.child('players/' + PLAYER_ID).set({
                    id: PLAYER_ID,
                    name: name,
                    score: 0,
                    joinedAt: Date.now()
                });

                document.getElementById('waiting-message').textContent = 
                    `Welcome, ${name}! Waiting for host...`;

                showScreen('waiting-screen');
                startListening();
            }).catch((error) => {
                showError('Error joining: ' + error.message);
            });
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function updateScoreDisplay() {
            document.getElementById('game-score').textContent = playerState.score;
            document.getElementById('waiting-score').textContent = playerState.score;
            document.getElementById('final-score').textContent = playerState.score + ' PTS';
        }

        function startListening() {
            // Listen for game start
            gameRef.child('isRunning').on('value', (snapshot) => {
                const isRunning = snapshot.val();
                if (isRunning && document.getElementById('waiting-screen').classList.contains('active')) {
                    showScreen('game-screen');
                }
            });

            // Listen for game over
            gameRef.child('gameOver').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    showEndScreen();
                }
            });

            // Listen for current round
            gameRef.child('currentRound').on('value', (snapshot) => {
                const round = snapshot.val();
                if (round !== null && round !== currentRound) {
                    currentRound = round;
                    loadRound(round);
                }
            });

            // Listen for round data
            gameRef.child('roundData').on('value', (snapshot) => {
                const roundData = snapshot.val();
                if (roundData) {
                    document.getElementById('round-banner').textContent = 
                        `ROUND ${currentRound + 1}: ${roundData.name}`;
                }
            });

            // Listen for player score updates
            gameRef.child('players/' + PLAYER_ID + '/score').on('value', (snapshot) => {
                const score = snapshot.val() || 0;
                playerState.score = score;
                updateScoreDisplay();
            });

            // Listen for active items (catch & speed rounds)
            gameRef.child('activeItems').on('value', (snapshot) => {
                const items = snapshot.val() || {};
                syncItems(items);
            });
        }

        function loadRound(roundIndex) {
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = '';
            activeItems.clear();
            memoryFlipped = [];

            // Initialize audio if not already
            if (!audioContext) initAudio();

            // Show instruction screen with countdown
            const round = ROUNDS[roundIndex];
            let instructionText = '';
            
            if (round.type === 'catch') {
                instructionText = 'TAP FALLING ELVES!<br>First tap wins!';
            } else if (round.type === 'memory') {
                instructionText = 'FIND MATCHING PAIRS!<br>+15 per match';
            } else if (round.type === 'speed') {
                instructionText = 'TAP TARGETS FAST!<br>+20 per hit';
            } else if (round.type === 'deli') {
                instructionText = 'TAP CARA AS FAST AS YOU CAN!<br>The most taps wins!';
            }

            gameArea.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">${round.icon}</div>
                    <div style="font-size: 1.5rem; color: #ff00ff; text-shadow: 0 0 20px #ff00ff; margin-bottom: 20px;">${round.name}</div>
                    <div style="font-size: 1rem; color: #00ff00; line-height: 1.8;">${instructionText}</div>
                    <div style="font-size: 1.5rem; color: #ffff00; margin-top: 30px; text-shadow: 0 0 15px #ffff00; animation: pulse 1.5s ease-in-out infinite;" id="waiting-message">
                        ‚è≥ Waiting for host to start... ‚è≥
                    </div>
                    <div style="font-size: 2.5rem; color: #ffff00; margin-top: 30px; text-shadow: 0 0 25px #ffff00; display: none;" id="player-countdown">3</div>
                </div>
            `;

            // Listen for host to click start button
            const roundStartListener = gameRef.child('roundStarted').on('value', (snapshot) => {
                const started = snapshot.val();
                if (started === true) {
                    // Remove listener
                    gameRef.child('roundStarted').off('value', roundStartListener);
                    
                    // Hide waiting message, show countdown
                    const waitingMsg = document.getElementById('waiting-message');
                    const countdownEl = document.getElementById('player-countdown');
                    if (waitingMsg) waitingMsg.style.display = 'none';
                    if (countdownEl) countdownEl.style.display = 'block';
                    
                    // Start countdown
                    startPlayerCountdown(round);
                }
            });
        }

        function startPlayerCountdown(round) {
            const gameArea = document.getElementById('game-area');
            
            // Countdown with sounds - 3 seconds
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownEl = document.getElementById('player-countdown');
                if (countdownEl) {
                    if (countdown > 0) {
                        countdownEl.textContent = countdown;
                        playSound('countdown');
                        vibrate(50);
                    } else {
                        countdownEl.textContent = 'GO!';
                        playSound('go');
                        vibrate(100);
                    }
                }
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    // Setup round after countdown
                    setTimeout(() => {
                        gameArea.innerHTML = ''; // Clear intro text
                        
                        // Start the appropriate game based on round type
                        if (round.type === 'memory') {
                            setupMemoryGame();
                        } else if (round.type === 'deli') {
                            setupDeliGame();
                        }
                        // Catch and speed games are synced via Firebase activeItems
                        // so no setup needed - they just listen for items
                    }, 500);
                }
            }, 1000);
        }

        function syncItems(items) {
            const gameArea = document.getElementById('game-area');
            const serverItems = Object.entries(items);

            // Round 0 (Catch) or Round 2 (Speed)
            if (currentRound === 0 || currentRound === 2) {
                // Remove items that no longer exist
                activeItems.forEach((itemEl, itemId) => {
                    if (!items[itemId]) {
                        itemEl.remove();
                        activeItems.delete(itemId);
                    }
                });

                // Add new items or update existing ones
                serverItems.forEach(([itemId, itemData]) => {
                    if (!activeItems.has(itemId)) {
                        addItem(itemId, itemData);
                    } else {
                        // Update position of existing items (for falling animation)
                        const itemEl = activeItems.get(itemId);
                        if (currentRound === 0 && itemEl) {
                            // Update Y position for falling items
                            itemEl.style.top = itemData.y + 'px';
                        }
                    }
                });
            }
        }

        function addItem(itemId, itemData) {
            const gameArea = document.getElementById('game-area');
            const itemEl = document.createElement('div');
            
            if (currentRound === 0) {
                // Catch game - falling items (all elf photos with red or green circles)
                itemEl.className = 'falling-item';
                
                // All items are now team photos
                const img = document.createElement('img');
                img.src = itemData.image;
                img.style.width = '90px'; // Bigger! (was 70px)
                img.style.height = '90px';
                img.style.borderRadius = '50%';
                img.style.border = itemData.good ? '4px solid #00ff00' : '4px solid #ff0000';
                img.style.boxShadow = itemData.good ? '0 0 20px #00ff00' : '0 0 20px #ff0000';
                img.style.pointerEvents = 'none';
                img.style.animation = 'elfPulse 0.8s ease-in-out infinite';
                
                // Handle image loading errors
                img.onerror = function() {
                    console.error('Failed to load image:', itemData.image);
                    // Show emoji fallback
                    itemEl.textContent = itemData.good ? '‚úÖ' : '‚ùå';
                    itemEl.style.fontSize = '4rem';
                };
                
                itemEl.appendChild(img);
                
                // Add pulsing animation style
                if (!document.getElementById('elf-pulse-style')) {
                    const style = document.createElement('style');
                    style.id = 'elf-pulse-style';
                    style.textContent = `
                        @keyframes elfPulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.15); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                itemEl.style.left = itemData.x + '%';
                itemEl.style.top = itemData.y + 'px';
            } else if (currentRound === 2) {
                // Speed game - elf photos as targets!
                itemEl.className = 'speed-target';
                
                if (itemData.image) {
                    // Use elf photo
                    const img = document.createElement('img');
                    img.src = itemData.image;
                    img.style.width = '80px';
                    img.style.height = '80px';
                    img.style.borderRadius = '50%';
                    img.style.border = '4px solid #ff00ff';
                    img.style.boxShadow = '0 0 20px #ff00ff';
                    img.style.pointerEvents = 'none';
                    img.onerror = function() {
                        itemEl.textContent = 'üéØ';
                        itemEl.style.fontSize = '4rem';
                    };
                    itemEl.appendChild(img);
                } else {
                    // Fallback to emoji
                    itemEl.textContent = itemData.emoji || 'üéØ';
                }
                
                itemEl.style.left = itemData.x + '%';
                itemEl.style.top = itemData.y + '%';
            }

            itemEl.addEventListener('click', () => catchItem(itemId, itemData));
            itemEl.addEventListener('touchstart', (e) => {
                e.preventDefault();
                catchItem(itemId, itemData);
            });

            gameArea.appendChild(itemEl);
            activeItems.set(itemId, itemEl);
        }

        function catchItem(itemId, itemData) {
            const itemEl = activeItems.get(itemId);
            if (!itemEl) return;

            // Initialize audio on first interaction
            if (!audioContext) initAudio();

            // Play sound and vibrate
            if (itemData.points > 0) {
                playSound('catch-good');
                vibrate(50); // Short vibration for good items
            } else {
                playSound('catch-bad');
                vibrate([100, 50, 100]); // Pattern for bad items
            }

            // Send catch to Firebase
            gameRef.child('caughtItems').push({
                itemId: itemId,
                playerId: PLAYER_ID,
                timestamp: Date.now()
            });

            // Show feedback with points gained/lost
            const pointsText = itemData.points > 0 ? `+${itemData.points}` : `${itemData.points}`;
            showFeedback(itemEl, pointsText);

            // Remove item locally
            itemEl.remove();
            activeItems.delete(itemId);
        }

        // Memory Game
        function setupMemoryGame() {
            const gameArea = document.getElementById('game-area');
            
            // More icons for harder game - 12 pairs (24 cards)
            const icons = ['üéÅ', '‚≠ê', 'üéÑ', 'üç¨', '‚ùÑÔ∏è', 'üîî', 'üéÖ', 'ü¶å', 'üé™', 'üé∫', 'üéª', 'üé∏'];
            memoryCards = [...icons, ...icons].sort(() => Math.random() - 0.5);

            const gridHtml = `
                <div class="memory-grid" style="grid-template-columns: repeat(4, 1fr); max-width: 500px; gap: 8px; padding: 15px;">
                    ${memoryCards.map((icon, index) => `
                        <div class="memory-card" data-card-id="${index}" data-icon="${icon}" style="font-size: 2.2rem;">
                            ‚ùì
                        </div>
                    `).join('')}
                </div>
            `;

            gameArea.innerHTML = gridHtml;

            // Add click handlers
            document.querySelectorAll('.memory-card').forEach(card => {
                const cardId = parseInt(card.dataset.cardId);
                card.addEventListener('click', () => flipCard(cardId, card));
                card.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    flipCard(cardId, card);
                });
            });
        }

        function flipCard(cardId, cardEl) {
            if (memoryFlipped.length >= 2) return;
            if (cardEl.classList.contains('matched')) return;
            if (cardEl.classList.contains('flipped')) return;

            // Initialize audio if not already
            if (!audioContext) initAudio();
            
            // Play flip sound
            playSound('tap');
            vibrate(20);

            const icon = cardEl.dataset.icon;
            cardEl.textContent = icon;
            cardEl.classList.add('flipped');
            memoryFlipped.push({ id: cardId, icon: icon, el: cardEl });

            if (memoryFlipped.length === 2) {
                setTimeout(checkMemoryMatch, 800);
            }
        }

        function checkMemoryMatch() {
            const [first, second] = memoryFlipped;

            if (first.icon === second.icon) {
                // Match!
                first.el.classList.add('matched');
                second.el.classList.add('matched');
                
                // Play match sound and vibrate
                playSound('match');
                vibrate(100);
                
                // Award points locally and sync to Firebase
                playerState.score += 15;
                gameRef.child('players/' + PLAYER_ID + '/score').set(playerState.score);
                updateScoreDisplay();
                
                showFeedback(first.el, '+15');
            } else {
                // No match - short error vibration
                vibrate([30, 20, 30]);
                
                first.el.textContent = '‚ùì';
                second.el.textContent = '‚ùì';
                first.el.classList.remove('flipped');
                second.el.classList.remove('flipped');
            }

            memoryFlipped = [];
        }

        // Deli Counter Game
        function setupDeliGame() {
            const gameArea = document.getElementById('game-area');
            
            gameArea.innerHTML = `
                <div class="boss-container" style="background-image: url('deli-background.png'); background-size: cover; background-position: center; position: relative; overflow: hidden;">
                    <!-- Dark overlay for better contrast -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); pointer-events: none;"></div>
                    
                    <!-- Cara in center -->
                    <div style="position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px;">
                        <img src="Cara.jpg" id="cara-deli" style="width: 200px; height: 200px; border-radius: 50%; border: 6px solid #ff00ff; box-shadow: 0 0 30px #ff00ff, 0 10px 40px rgba(0, 0, 0, 0.5); cursor: pointer; user-select: none; animation: deliFloat 1.5s ease-in-out infinite;">
                        <div style="font-size: 1.5rem; color: #ff00ff; text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff, 2px 2px 4px rgba(0,0,0,0.8); margin: 25px 0; text-align: center; font-weight: bold;">
                            CARA'S CHRISTMAS DELI COUNTER
                        </div>
                        <div class="boss-instruction" style="margin-top: 15px; background: rgba(0, 0, 0, 0.8); padding: 15px; border-radius: 10px; border: 2px solid #ff00ff;">
                            TAP CARA TO GET YOUR TICKET!<br>
                            <span style="font-size: 0.8rem;">+10 points per tap!</span><br>
                            <span style="font-size: 0.7rem; color: #ffff00;">Most taps wins this round!</span>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes deliFloat {
                        0%, 100% { transform: translateY(0) scale(1); }
                        50% { transform: translateY(-12px) scale(1.03); }
                    }
                </style>
            `;

            const cara = document.getElementById('cara-deli');
            cara.addEventListener('click', tapCara);
            cara.addEventListener('touchstart', (e) => {
                e.preventDefault();
                tapCara();
            });
        }

        function tapCara() {
            // Initialize audio on first interaction
            if (!audioContext) initAudio();
            
            // Play tap sound and vibrate
            playSound('tap');
            vibrate(30); // Quick tap feedback
            
            playerState.score += 10;
            gameRef.child('players/' + PLAYER_ID + '/score').set(playerState.score);
            updateScoreDisplay();

            const cara = document.getElementById('cara-deli');
            if (cara) {
                showFeedback(cara, '+10');
                
                // Tap effect
                cara.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    cara.style.transform = 'scale(1)';
                }, 100);
            }
        }

        function showFeedback(element, text) {
            const feedback = document.createElement('div');
            feedback.className = 'tap-feedback';
            feedback.textContent = text;
            feedback.style.left = element.offsetLeft + element.offsetWidth / 2 + 'px';
            feedback.style.top = element.offsetTop + 'px';
            
            // Red for negative points, green for positive
            if (text.toString().includes('-')) {
                feedback.style.color = '#ff0000';
                feedback.style.textShadow = '0 0 20px #ff0000';
            } else {
                feedback.style.color = '#00ff00';
                feedback.style.textShadow = '0 0 20px #00ff00';
            }
            
            element.parentElement.appendChild(feedback);
            setTimeout(() => feedback.remove(), 800);
        }

        function showEndScreen() {
            showScreen('end-screen');

            // Get final rankings
            gameRef.child('players').once('value').then((snapshot) => {
                const players = snapshot.val() || {};
                const sorted = Object.values(players).sort((a, b) => (b.score || 0) - (a.score || 0));
                const rank = sorted.findIndex(p => p.id === PLAYER_ID) + 1;

                const rankEl = document.getElementById('final-rank');
                if (rank === 1) {
                    rankEl.textContent = 'ü•á 1ST PLACE!';
                    rankEl.style.color = '#ffd700';
                } else if (rank === 2) {
                    rankEl.textContent = 'ü•à 2ND PLACE!';
                    rankEl.style.color = '#c0c0c0';
                } else if (rank === 3) {
                    rankEl.textContent = 'ü•â 3RD PLACE!';
                    rankEl.style.color = '#cd7f32';
                } else {
                    rankEl.textContent = `#${rank} PLACE`;
                    rankEl.style.color = '#00ffff';
                }
            });
        }
    </script>
</body>
</html>
